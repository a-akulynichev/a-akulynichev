# Kasko2go Open source for Android

Open source solution SDK for Android description consists of the following components:
- [Steps to start an Open source project](#start)
- [Steps fоr integrating the Open source into your solutions](#integrating);
- [Description of interaction with the Open source solution APIs to obtain scoring data](#scoring);
- [Onboarding and main screens for Android](#onbording).

<br/>


<a name="start"></a>
## Steps to start an Open source project 

To work with the Open source project you need to receive the access to our repositories on [Github][git] that contain source codes and technical documentation of the project.
Provide our [Technical Support Service][TSS] with the information about your Github user account ([Github][git] e-mail address) and receive the following access parameters:
- USER - account username;
- PASSWORD - user account password;
- NAVIGATOR_URL - navigation service address URL. 


<br/>

### Telematic data

Find the `sdk-telemetry/keystore.properties` file in the source code repository. Add the lines with access parameters received from out [Technical Support Service][TSS] to the end of the `sdk-telemetry/keystore.properties` file:
```
WEB_API="https://scoring-api.kasko2go.net/api/"
RECEIVER="receiver.kasko2go.net"
USER="<user_name>"
PASSWORD="<user_password>"
NAVIGATOR_URL="<https://navigation_url.host.com/>"
```



### Cartography service
1. To work with Google autocomplete service receive an **API key for the Maps SDK for Android**. The procedure for receiving the key is described in [Using API Keys][UAPIK].
Specify the received Google **API key for the Maps SDK for Android** in `sdk-telemetry/keystore.properties` file in the following form:
```
GOOGLE_API_KEY="<api_key>"
```

2. To work with Google maps services receive a **Google Maps API key**. The procedure for receiving the key is described in [Maps SDK for Android Quickstart][MSDK].
Specify the received Google **Maps API key** in `app/src/main/AndroidManifest.xml` file in the following form:
```
 <meta-data
    android:name="com.google.android.geo.API_KEY"
    android:value="<key>" />
```


### Firebase services

Provide interaction of your Android application with Firebase services. For this add the `google-services.json` configuration file to your mobile application. Follow [this link for][FB] the procedure of adding the `google-services.json` configuration file to your mobile application. 

<br/>

<a name="integrating"></a>
## Steps fоr integrating the Open source into your solutions 


### Initialization Android SDK

To integrate the Open source solution SDK into your new project, you need to perform the following steps after contacting our [Technical Support Service][TSS]: 
1. Add necessary permissions <br/>
Add necessary permissions to your new project and ask a smartphone user to allow these permissions:
- Internet
- application operation in the background 
- geolocation service
- physical activity
- disabling power-saving mode
- enabling Bluetooth adapter
- you must declare a dependency to the Google Location and Activity Recognition API version 12.0.0 or higher 

```
   <uses-permission android:name="android.permission.INTERNET" />
   <uses-permission android:name="android.permission.ACCESS_BACKGROUND_LOCATION" />
   <uses-permission android:name="android.permission.ACCESS_FINE_LOCATION" />
   <uses-permission android:name="android.permission.ACTIVITY_RECOGNITION" />
   <uses-permission android:name="android.permission.REQUEST_IGNORE_BATTERY_OPTIMIZATIONS" />
   <uses-permission android:name="android.permission.BLUETOOTH" />
   <uses-permission android:name="com.google.android.gms.permission.ACTIVITY_RECOGNITION" />
 ```


2. Implement metadata <br/>
Metadata contains extra information about a user, a device and a vehicle:
- userId - unique identifier of the user
- deviceId - unique identifier of the device
- vehicleId - unique identifier of the vehicle
These identifiers allow to uniquely identify a user, are randomly generated by the mobile application, must be unique and have a constant value for each user and user device. If the mobile application has been reinstalled, these identifiers are generated again.  
<br/>
The identifiers userId, deviceId, vehicleId are described by the following class:

```
 class Metadata(
       userId: String,
       vehicleId: String,
       deviceId: String,
       tag: String,
       val appId: String,
       val appVersion: String,
       val mobileModel: String,
       val osVersion: String,
       val isBluetoothOn: Boolean
       )
```

3. Add speed configs <br/>
To minimise battery power consumption, in SDK you can configure parameters of the `autostart_gps_filters` filter that has the following set of parameters:
- time - periodicity of obtaining coordinates from the GPS system, time in seconds   
- distance - periodicity of obtaining coordinates from the GPS system, distance travelled in metres
- uspeed - upper threshold of vehicle speed, km/h
- dspeed - lower threshold of vehicle speed, km / h
The parameters of the `autostart_gps_filters` filter determine the periodicity with which the mobile application receives and sends GPS system data to the server for further processing. The `autostart_gps_filters` filter starts working  after trip start validation and has the logic:
- if the urrent GPS speed >= dspeed and GPS speed < uspeed and the previous filtering state differs from the current one, then apply a new filter by time = time (in seconds) and filter by distance = distance (in meters). 
- If the previous speed value was within the same limits as the current one, then do not change the filter characteristics.
The autostart_gps_filters filter with default parameter values is a variable with  JSON of the type:

```
  val configs = """
    [
    {
        "time": 18,
        "distance": 200,
        "uspeed": 70,
        "dspeed": 0
    },
    {
        "time": 18,
        "distance": 400,
        "uspeed": 110,
        "dspeed": 60
    },
    {
        "time": 18,
        "distance": 600,
        "uspeed": 150,
        "dspeed": 100
    },
    {
        "time": 18,
        "distance": 800,
        "uspeed": 190,
        "dspeed": 140
    },
    {
        "time": 18,
        "distance": 1000,
        "uspeed": 230,
        "dspeed": 180
    },
    {
        "time": 18,
        "distance": 1200,
        "uspeed": 1000,
        "dspeed": 220
    }
]
    
    """
    DetectorSdk.setSpeedConfig(context, configs)
 
```


4. Working with Bluetooth module (optional) <br/>
SDK provides an opportunity to identify the trip start moment through connecting the smartphone bluetooth module to the vehicle bluetooth. 
<br/>
To work with the smartphone bluetooth module, follow these steps:

```
   val prefs = context.getSharedPreferences(BTConnectedMonitor.BT_PREFS, Context.MODE_PRIVATE)
   prefs.edit(commit = true) {
       putString(BTConnectedMonitor.BT_ADDRESS, address)
       putString(BTConnectedMonitor.BT_NAME, name)
   }
```
 
5. SDK initialisation <br/>
To initialise the SDK, follow these steps:

```
    val config = ConfigBuilder(
            host = BuildConfig.RECEIVER,
            port = BuildConfig.RECEIVER_PORT
        )
            .setStartValidationTimeout(180)
            .setStopValidationTimeout(300)
            .build()

    DetectorSdk.start(context, config, getMetadata())
 ```
 
 <br/>


<a name="scoring"></a>
## Interaction with the Open source solution APIs to obtain scoring data 



The Open source solution SDK for Android allows a user to get the following information:

1. Data on trips made over a specified period of time.
Use the following API method  to receive information on trips made over a specified period of time:  
```
 ScoringSdk.getTrips(
           vehicleUUID = getVehicleId(),
           deviceId = getDeviceId(),
           userId = getUserId(),
           to = DateTime.now().millis / 1000,
           from = null
   )

   fun getTrips(
        vehicleUUID: UUID, // vehicle id for identification
        deviceId: UUID, // device id for identification
        userId: UUID, // user id for identification
        to: Long?, // date to filed for filtering
        from: Long?, // date from filed for filtering
        limit: Int = 20, // limit of records in response for pagination
        offset: Int = 0 // offset of records for pagination
    ): Single<ScoringTrips>

    data class ScoringTrips(
        val limit: Long?, // limit of records in response for pagination
        val totalCount: Long, // total count of records in response for pagination
        val values: List<ScoringTrip>
    )

    data class ScoringTrip(
        val tripData: TripData,
        val scoring: ScoreData?
    )

    data class TripData(
        val id: UUID, // Unique identifier of the trip
        val userId: String?, // Unique identifier of the user
        val deviceId: String?, // Unique identifier of the device
        val vehicleId: String?, // Unique identifier of the vehicle
        val startTimestamp: DateTime, // Start time of the trip (UNIX timestamp)
        val finishTimestamp: DateTime, // Finish time of the trip (UNIX timestamp)
        val tag: TripDataTag // A value that the trip has been tagged with
        val isBluetoothOn: true, // Is bluetooth on
        val isBluetoothConnectionEstablished: true // Is bluetooth connection establihed
    )

```

2. Detailed information on the trip that has been made.
Use the following API method to receive information on a specified trip:
```
 ScoringSdk.getTripsInfo(tripId)

   fun getTripsInfo(
       tripId: UUID, // id of trip
       loadAllEvents: Boolean = true, // flag for load all events
       mapToRoads: Boolean = true // flag for mapping
   ): Single<ScoringTripDetails>

   data class ScoringTripDetails(
        val trip: ScoredTrip, // trip details
        val events: List<TelemetryEvent>? = null, // trip events
        val penalties: List<Penalty>, // trip penalties
        val startAddress: String, // start trip address
        val endAddress: String, // end trip address
        val interactiveMapEnabled: Boolean? // ?
    )

    data class TelemetryEvent(
        val timestamp: Long, // Date and time of the event (UNIX timestamp)
        val latitude: Double, // Latitude of the location point (in signed degrees format)
        val longitude: Double, // Longitude of the location point (in signed degrees format)
        val speedKph: Double, // The speed of the object at the specified time (in kilometers per hour)
        val heading: Double, // ompass direction in which the object's bow or nose is pointed (0 or 360 indicates a direction toward true North)
        val accuracy: Double // The accuracy of the location information
    )

    data class Penalty(
        val timestamp: Long, // Date and time of the event (UNIX timestamp)
        val type: PenaltyType, // The type of the event
        val durationMs: Long, // The duration (in milliseconds) of the event
        val value: Double // Indicates the severity of the event (depends on the type)
    )

    enum class PenaltyType {
        BRAKING,
        ACCELERATION,
        OVER_SPEED,
    }
```


3. The weighted average of the score and the total value of vehicle mileage over a certain period of time.
Use the following API method to receive information:   

```
 ScoringSdk.getScoring(
           vehicleUUID = getVehicleId(),
           deviceId = getDeviceId(),
           userId = getUserId(),
           dateFrom = 0
   )

   fun getScoring(
       vehicleUUID: UUID, // vehicle id for identification
        deviceId: UUID, // device id for identification
        userId: UUID, // user id for identification
        dateFrom: Long,  // date from filed for filtering
        tag: TripDataTag = TripDataTag.DRIVER_IN_MY_CAR // tag field for filtering
    ): Single<ScoreData>

    data class ScoreData(
        val scorePercent: Double, // score percent for all selected trips
        val durationSec: Long, // duration in sec for all selected trips
        val distanceMeters: Long, // distance in meters for all selected trips
        val tripsCount: Long // count of for all selected trips
    )
```

4. Building a vehicle route/routes, getting information about dangerous road sections.
Use the following API method to get the information about vehicle routes and risks related to traveling along each of those routes:<br/>
Request method:  

```
 RoutesSdk.getRoutes(
       originLat: Double,
       originLng: Double,
       destinationLat: Double,
       destinationLng: Double,
       departureTime: Long?,
 )
```

Response parameters:
```
 @Parcelize
 data class Route(
   val distance: Double,
   val duration: Long,
   val accidentRisk: Double,
   val riskCountForUi: Int,
   val riskCountForUiColor: String,
   val inactiveRouteColor: String,
   val lowRiskDistance: Double,
   val lowRiskPercentage: Double,
   val normalRiskDistance: Double,
   val normalRiskPercentage: Double,
   val highRiskDistance: Double,
   val highRiskPercentage: Double,
   val highRiskLinks: List<HighRiskLink>,
   val road: Road,
   val waypoints: List<LatLng>
 ) : Parcelable

 @Parcelize
 data class HighRiskLink(
   val description: String,
   val accidentsCount: Int,
   val accidentsYears: String,
 ) : Parcelable

 @Parcelize
 data class Road(
   val baseRoute: List<LatLng>,
   val baseColor: String,
   val lowRoute: List<List<LatLng>>,
   val lowColor: String,
   val normalRoute: List<List<LatLng>>,
   val normalColor: String,
   val highRoute: List<List<LatLng>>,
   val highColor: String,
 ) : Parcelable

 @Parcelize
 data class RoutesWrapper(
   val routes: List<Route>
) : Parcelable
```


# Onboarding and main screens for Android

When application is started for the first time, user should go through onboarding screens starting from 0.0 to 1.6. After that Main screen should be opened and it should be opened automatically every time when the app is started, user should go through onboarding screens starting from 2.0 to 4.1. 
<br/>

Authorization/registration is not required.
<br/>

<a name="onboarding"></a>
[Onboarding (intro & initial settings) screens ](./OP-Android-Onboarding.pdf)

 
 
 [git]: <https://github.com/>
 [TSS]: <mailto:info@kasko2go.com>
 [UAPIK]: <https://developers.google.com/maps/documentation/android-sdk/get-api-key>
 [MSDK]: <https://developers.google.com/maps/documentation/android-sdk/start>
 [FB]: <https://firebase.google.com/docs/android/setup#add-config-file>
 [SAA]: <https://github.com/a-akulynichev/md_test/blob/main/Sample_App_%20Android.md>
